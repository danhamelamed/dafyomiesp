<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daf Yomi por Daniel Hamelamed - Guayaquil Ecuador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.4;
    }
    .hebrew {
      font-size: 1.5rem;
      direction: rtl;
      font-weight: bold;
      font-family: 'Noto Sans Hebrew', 'David Libre', serif;
    }
    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      height: 8px;
      background-color: #4ade80;
      z-index: 50;
    }
    .talmud-header {
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      animation: scroll-left 20s linear infinite;
    }
    @keyframes scroll-left {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="progress-bar" id="progressBar" style="width: 0%"></div>

  <header class="bg-white shadow p-4 text-center relative">
    <h1 class="text-2xl font-bold">Daf Yomi por Daniel Hamelamed - Guayaquil Ecuador</h1>
    <div class="talmud-header absolute bottom-0 left-0 right-0 text-gray-400">
      Zeraim Nashim Moed Nezikin Kodashim Taharot Zeraim Nashim Moed Nezikin Kodashim Taharot...
    </div>
  </header>

  <main class="max-w-2xl mx-auto p-4">
    <div class="mb-4 flex gap-2 flex-wrap">
      <select id="masechet" class="p-2 border rounded w-full sm:w-auto"></select>
      <input id="daf" type="number" min="2" value="2" class="p-2 border rounded w-24" />
      <button onclick="loadFirstLines()" class="bg-blue-600 text-white px-4 py-2 rounded">Cargar Daf</button>
    </div>

    <div id="dafNumber" class="text-sm text-gray-500 mb-2"></div>
    <div id="content" class="space-y-4"></div>
    <button onclick="nextLines()" class="mt-8 bg-green-600 text-white px-4 py-2 rounded block mx-auto">Siguiente línea</button>
    <button onclick="generatePDF()" class="mt-2 bg-purple-600 text-white px-4 py-2 rounded block mx-auto">Descargar PDF</button>
  </main>

  <script>
    const masechtot = ["Berajot", "Shabat", "Eruvin", "Pesajim", "Shekalim", "Yoma", "Suká", "Beitzá", "Rosh Hashaná", "Taanit", "Meguilá", "Moed Katán", "Jagigá", "Yevamot", "Ketuvot", "Nedarim", "Nazir", "Sotá", "Guitín", "Kidushín", "Baba Kama", "Baba Metzia", "Baba Batra", "Sanhedrín", "Makot", "Shevuot", "Avodá Zará", "Horaiot", "Zevajim", "Menajot", "Julin", "Bejorot", "Arajín", "Temurá", "Keritot", "Meilá", "Tamid", "Midot", "Kinim", "Nidá"];
    
    const masechetSelect = document.getElementById('masechet');
    masechtot.sort().forEach(m => {
      const option = document.createElement('option');
      option.value = m;
      option.textContent = m;
      masechetSelect.appendChild(option);
    });

    let currentIndex = 0;
    let allLines = [];

    async function loadFirstLines() {
      const masechet = document.getElementById("masechet").value;
      const daf = document.getElementById("daf").value;
      currentIndex = 0;
      document.getElementById("content").innerHTML = "";
      document.getElementById("dafNumber").innerText = `Daf ${daf} - ${masechet}`;
      
      const sefariaUrl = `https://www.sefaria.org/api/texts/${masechet}.${daf}?lang=he&context=0`;
      const response = await fetch(sefariaUrl);
      const data = await response.json();

      allLines = data.he.filter(line => line.trim() !== "");
      nextLines();
    }

    async function nextLines() {
      if (currentIndex >= allLines.length) return;

      const linesToShow = allLines.slice(currentIndex, currentIndex + 2);
      currentIndex += 2;
      updateProgress();

      const hebrewText = linesToShow.join("\n");
      const res = await fetch("https://dafyomi-api.danfuenteslopez.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: `Explica en español las siguientes líneas del Talmud de forma clara y breve. Incluye: traducción literal, transliteración aproximada, y explicación sencilla para cada una. No uses material fuera de este Daf.\n\n${hebrewText}` })
      });
      const { result } = await res.json();

      const block = document.createElement("div");
      block.innerHTML = `
        <div class="hebrew">${hebrewText}</div>
        <div class="bg-white p-4 shadow rounded">
          ${result.replace(/\n/g, "<br>")}
        </div>
      `;
      document.getElementById("content").appendChild(block);
    }

    function updateProgress() {
      const progress = Math.min((currentIndex / allLines.length) * 100, 100);
      document.getElementById("progressBar").style.width = `${progress}%`;
    }

    async function generatePDF() {
      const content = document.getElementById("content").innerHTML;
      const html = `
        <html><head><meta charset='utf-8'></head><body>${content}</body></html>
      `;
      const blob = new Blob([html], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dafyomi.pdf";
      a.click();
    }

    loadFirstLines();
  </script>
</body>
</html>
